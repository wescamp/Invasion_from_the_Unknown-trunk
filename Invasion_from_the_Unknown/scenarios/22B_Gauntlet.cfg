#textdomain wesnoth-Invasion_from_the_Unknown
[scenario]
    id=22B_Gauntlet
    name= _ "The Gauntlet"
    {MAP 22B_Gauntlet.map}
    {TURNS 46 45 44}
    next_scenario=23A_Interim
    victory_when_enemies_defeated=no
    {NO_RECALLS}

    {EX_SCENARIO_MUSIC_PLAYLIST (
        {EX_MUSIC        "heroes_rite.ogg"  }
        {EX_MUSIC_APPEND "the_deep_path.ogg"}
        {EX_MUSIC_APPEND "nunc_dimittis.ogg"}
        {EX_MUSIC_APPEND "suspense.ogg"      }
    )}

    {INDOORS_HIVE}

    {DEATHS_END}
    {GLAMOUR_INIT_STUB}
    {GLAMOUR_EVENTS}

    {STORYTXT_GAUNTLET}
    {STORYMAP_GAUNTLET}

    [side]
        type=Elvish Hero
        id=Galas
        name= _ "Galas"
        unrenamable=yes
        side=1
        canrecruit=yes
        controller=human
        team_name=good
        user_team_name= _ "team_name^Galas"
        shroud=yes
        fog=yes
        income=-2
        gold=0
        village_gold=0
    [/side]

    # Boss supporters
    [side]
        side=2
        controller=ai
        no_leader=yes
        team_name=foes
        user_team_name= _ "team_name^Loyalists"
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Lore) 62 16}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Lore) 62 21}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Iron Golem) 57 17}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Iron Golem) 57 21}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Heavy Assault Trooper) 52 17}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Heavy Assault Trooper) 51 20}
        {MAKE_FACING_REVERSE}
    [/side]

    # Boss
    [side]
        side=3
        no_leader=yes
        team_name=foes
        user_team_name= _ "team_name^Loyalists"
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        [ai]
            # built-in default is 1.0, doesn't do it very well, so here I set 10.0
            # FIXME: looks like it prevents Elyssa from attacking
            # protect_leader=10.0
            # Dumb kamikaze-style AI which just wants to kill, no matter how
            # it should be. Focus on the leader anyway.
            leader_value=6
            caution=0.0
            aggression=1.0
            # Don't even think on recruiting; might save a few milliseconds
            # of gameplay, not sure.
            recruitment_pattern=""
            village_value=0.0
        [/ai]
    [/side]

    # Hive
    [side]
        side=4
        no_leader=yes
        team_name=foes
        user_team_name= _ "team_name^Hive dwellers"
        #         ai_algorithm=formula_ai
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
    [/side]

    # Doors and matrices (fake player)
    [side]
        side=5
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {IS_NPC}
        {CHAOS_FLAG}
        # We create manually each door, unlike the previous scenario, because two of the door tiles
        # in the map are supposed not be opened until the boss is defeated
        [unit]
            [modifications]
                {TRAIT_MECHANICAL}
            [/modifications]
            type=Door
            x,y=21,23
        [/unit]
        [unit]
            [modifications]
                {TRAIT_MECHANICAL}
            [/modifications]
            type=Door
            x,y=25,18
        [/unit]
        [unit]
            [modifications]
                {TRAIT_MECHANICAL}
            [/modifications]
            type=Door
            x,y=39,22
        [/unit]
        [unit]
            [modifications]
                {TRAIT_MECHANICAL}
            [/modifications]
            type=Door
            x,y=46,20
        [/unit]
        [unit]
            [modifications]
                {TRAIT_MECHANICAL}
            [/modifications]
            type=Door
            x,y=44,18
        [/unit]
        [unit]
            [modifications]
                {TRAIT_MECHANICAL}
            [/modifications]
            type=Door
            x,y=47,17
        [/unit]
    [/side]

    # Side which controls wandering Wyrms
    [side]
        side=6
        controller=ai
        no_leader=yes
        {IS_HOSTILE_NPC}
        {CHAOS_FLAG}
        team_name=foes
        {HIDDEN_TEAM}
    [/side]

    {SETUP_SHAXTHAL_ROAMING_SOUND_EFFECTS}

    [event]
        name=prestart
        {VARIABLE trance_timeout 0 }

        [recall]
            id=Elynia
        [/recall]
        [recall]
            id=Mal Keshar
        [/recall]
        [recall]
            id=Erathan
        [/recall]
        [recall]
            id=Lédinor
        [/recall]
        [recall]
            id=Igor
        [/recall]

        {GAUNTLET_RECALL_METALIST}

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Explore and find your way to the main Keep with Galas, Elynia or Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES {ENEMY_RESPAWNING_WARNING} }
        [/objectives]
    [/event]

    # Setup NPC spawn points
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 14 10 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 24 24 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 16 29 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 33 28 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 43 22 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 41 14 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 60 4 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 48 2 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 66 27 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 63 3 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Wyrm") 6 68 2 yes 2}

    # Setup NPC behavior
    {NPC_BIRD_BEHAVIOR 6 1 70 1 30}

    # Setup enemy spawn points
#ifdef HARD
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 17 26 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 4 12 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 14 13 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 25 16 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 9 29 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 33 16 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 31 27 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 35 19 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 66 23 yes 2}
#endif
#ifndef EASY
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 10 11 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 16 12 yes 5}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 21 30 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 24 27 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 29 16 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 37 27 yes 4}
#endif
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 2 13 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 6 11 no 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 12 12 no 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 20 14 no 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 23 15 yes 7}
    {HIVE_SPAWN_POINT ("Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 31 14 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 15 27 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 13 28 yes 6}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 26 25 no 2}

    # Boss chamber passage spawn points
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 29 19 yes 5}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 31 19 no 5}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 33 19 yes 2}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 37 19 yes 7}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 29 27 yes 5}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 33 27 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Drone,Shaxthal Runner Drone") 4 35 27 yes 3}

    # Boss chamber spawn points
    {HIVE_SPAWN_POINT ("Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 45 15 yes 4}
    {HIVE_SPAWN_POINT ("Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 49 14 yes 3}
    {HIVE_SPAWN_POINT ("Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Protector Drone") 4 50 22 yes 2}

    [event]
        name=start
        {MSG_UNIT (Mal Keshar) ( _ "This place stinks with the smell of death and decay. Something seriously evil goes on in this... warren? Hive? Thing?")}

        {MSG_UNIT (Galas) ( _ "Given that these creeps float and have poison in their jaws, I'd call it a hive.")}

        {MSG_UNIT (Lédinor) ( _ "This place is simply wrong! The air, the walls... everything is unnatural! It is as if...")}

        {MSG_UNIT (Elynia) ( _ "... we were no longer in our own world. Not even Wesmere's underground tunnels can compare to this. There is a dark energy in the air; I would not be surprised if it tried to possess or destroy any of us at any moment.")}

        [if]
            {VARIABLE_BOOLEAN_EQUALS erathan_alive yes}
            [then]
                {MSG_UNIT (Erathan) ( _ "Look out! We have just come to be targets of a swarm of them!")}
            [/then]
            [else]
                {MSG_UNIT (Lédinor) ( _ "Look out! We have just come to be targets of a swarm of them!")}
            [/else]
        [/if]

        {MSG_UNIT (Galas) ( _ "Let's give them a lesson to remember. Eh... wait a moment... lava pits?")}

        [if]
            {VARIABLE_BOOLEAN_EQUALS erathan_alive yes}
            [then]
                {MSG_UNIT (Erathan) ( _ "They probably need the warmth of it to grow up. Like chicken and their eggs.")}
            [/then]
            [else]
                {MSG_UNIT (Lédinor) ( _ "They probably need the warmth of it to grow up. Like chicken and their eggs.")}
            [/else]
        [/if]

        {MSG_UNIT (Elynia) ( _ "A presence... that presence... I felt it when we were escaping from Knalga.")}

        {MSG_UNIT (Mal Keshar) ( _ "Could it be possibly related to whoever orchestrated that invasion?")}

        {MSG_UNIT (Elynia) ( _ "Perhaps.")}

        {MSG_UNIT (Galas) ( _ "If it is so, then he will feel my wrath for what he did to Anlindë.")}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=54-70
            y=14-24
        [/filter]
        [remove_shroud]
            side=1
            x=52-70
            y=14-26
        [/remove_shroud]

        {MSG_UNIT (Mal Keshar) ( _ "Oh, great. A welcome party indeed.")}

        {MSG_SUF (type=Chaos Lore) ( _ "Distract them, we must make some time before the Warlord arrives to finish them off!")}

        {MSG_SUF (type=Iron Golem) ( _ "En garde, elf!")}

        {MSG_UNIT (Galas) ( _ "The Chaos Warlord is coming here? That overlord, Benthos, he told us that Anlindë last fought against the Warlord... That assassin shall not go unpunished! Embrace yourselves!")}

        {MSG_UNIT (Elynia) ( _ "I am not sure it is a good idea... I sense a great power heading towards this place. It comes from behind those gates!")}

        [scroll_to]
            x,y=67,24
        [/scroll_to]
        {REDRAW}
        {DELAY 1500}

        {MSG_UNIT (Galas) ( _ "What else can we do now? Run like cowards? Never! We made it this far, and there is no looking back.")}

        {MSG_UNIT (Elynia) ( _ "That's true...")}

        {MSG_UNIT (Erathan) ( _ "Get out of our path, vermins!")}

        {MSG_SUF (type=Chaos Lore) ( _ "You shall not pass!")}

        {VARIABLE warlord_approaching yes}

        [event]
            name=new turn
            first_time_only=no
            [if]
                [not]
                    [have_unit]
                        side=2
                    [/have_unit]
                [/not]
                {VARIABLE_BOOLEAN_EQUALS warlord_approaching yes}
                [then]
                    {VARIABLE warlord_approaching no}
                    {PLAY_SOUND dwarf-laugh.wav}
                    # Boss appears
                    # Using a complete MUF locations array to avoid the possibility that the
                    # engine decides to make the fake unit fly over the lava
                    [move_unit_fake]
                        x=70,69,68,67,66,66,66,66,66,65,65
                        y=25,25,24,24,23,22,21,20,19,19,18
                        type=Fake Chaos Warlord
                        side=3
                    [/move_unit_fake]
                    [unit]
                        side=3
                        type=Chaos Warlord
                        id=Elyssa
                        name= _ "Elyssa"
                        x,y=65,18
                        {IS_BOSS}
                        unrenamable=yes
                        {FACING_REVERSE}
                        female=yes
                    [/unit]
                    [music]
                        name="the_city_falls.ogg"
                        immediate=yes
                    [/music]
                    {BOSS_POPUP}
                    {REDRAW}
                    [scroll_to_unit]
                        id=Elyssa
                    [/scroll_to_unit]
                    {DELAY 1000}

                    {MSG_UNIT (Mal Keshar) ( _ "The warlord is a female!")}

                    {MSG_UNIT Erathan ( _ "I guess those creatures couldn't tell...")}

                    {MSG_UNIT Elyssa ( _ "Galas, the elvish leader. You have no idea how much time I have been waiting for this moment, to see your face of terror and squash you like a bug, to squash you in the same manner the witch did with me.")}

                    {MSG_UNIT Galas ( _ "So you are the monster that killed Anlindë. You shall pay for that, and I'll make sure that no part of your body is left this time to resurrect you!")}

                    {MSG_UNIT Elyssa ( _ "Fool, there is no weapon or magical power left in this world to destruct me permanently. You will be only wasting your last minutes of life!")}

                    {MSG_UNIT Elynia ( _ "No, we will prevail. You are the one who will waste her last minutes of life.")}

                    {MSG_UNIT Elyssa ( _ "Ah, the so feared Lady of Light... you are nothing but a girl.")}

                    {MSG_UNIT (Mal Keshar) ( _ "Show us your face, demon!")}

                    {MSG_UNIT Elyssa ( _ "I do not have a face anymore, you fool! I'll teach you all the lesson that those vermins have failed to teach you! You shall respect those who are actually powerful, you shall respect the lords of Chaos, should you be dead or living!")}

                    [objectives]
                        side=1
                        {OBJECTIVE_TO_WIN ( _ "Defeat the Chaos Warlord")}
                        {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
                        {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
                        {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
                        {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
                        {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
                        {OBJECTIVE_NOTES {ENEMY_RESPAWNING_WARNING} }
                    [/objectives]
                [/then]
            [/if]
        [/event]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x,y=9,29
        [/filter]
        {MSG_NARRATOR ( _ "Long live the Machine!")}
    [/event]

    [event]
        name=victory
        {GAUNTLET_SAVE_RECALL_METALIST}

        {CLEAR_VARIABLE trance_timeout,warlord_approaching,x_diff,y_diff}
    [/event]

    {ITEM_CRYSTAL_GLYPH_MESSAGE 49 24}
    [event]
        name=moveto
        [filter]
            x,y=49,24
        [/filter]

        {ALLOW_UNDO}
        {REDRAW}

        {MSG_GLYPH ( _ "We, the Argazar people, fiddled perilously with the pillars of all lifeforms. And we created unspeakable abominations, that we were forced to enhance and mass-produce, as we were losing a war with the planet Rythé.")}
        {MSG_GLYPH ( _ "Those were the Shaxthals. With our knowledge of magic, genetics and technology combinated, we could select the best characteristics of every natural lifeform, add them great strength and resistance, and join them together in a single, new lifeform. The Biomechanicals, or 'Shaxthals', which in our ancient tongue meant 'invincibles'.")}
        {MSG_GLYPH ( _ "However, a cataclysm destroyed all our civilization and creations, except for a few of us who survived long enough to set a secret city underground.")}
        {MSG_GLYPH ( _ "The Rythenians thought we were gone.")}
        {MSG_GLYPH ( _ "But the Shaxthals had their own survival system.")}
        {MSG_GLYPH ( _ "Probably most of the biomechanicals that were in the planet's surface during the cataclysm were destroyed, but a small number of them could survive with us underground. However, we forgot an important detail: their instincts.")}
        {MSG_GLYPH ( _ "Their instincts prevailed, and commanded them to start consuming our civilization. To take our bodies and integrate them into their own lifeform. For they had an advanced assimilation system that allowed them to integrate into new environments, or adapt them to suit their needs.")}
        {MSG_GLYPH ( _ "Not sole environments, but their organisms too. The Shaxthals had the same knowledge of technology we had, but not the knowledge of genetics or magic. Yet, that was more than enough to convert our comrades into mindless servants of their 'system'.")}
        {MSG_GLYPH ( _ "Although we tried to make sure their hive could not grow bigger, we noticed that they had developed their own means of reproduction. Their numbers were increasing quickly.")}
        {MSG_GLYPH ( _ "With barely a few dozen of us left, we figured out a way to destroy the Shaxthals. The strongest ones, few though, survived. And our lores decided to keep them in cryogenic pods instead of destructing them forever, as they thought they could still be our last hope of survival.")}
        {MSG_GLYPH ( _ "But we eventually disappeared. We, as animals, got to a dead end, with no means of reproduction. Our attempts to reproduce our species in a similar way to that of the Shaxthals were futile.")}
        {MSG_GLYPH ( _ "Only our knowledge survived, in the form of these glyphs. And in the form of the pods that contained the remaining Shaxthals.")}
        {MSG_GLYPH ( _ "We hope with all our might that all this knowledge, technology and history, are not used for bad purposes.")}

        {MSG_UNIT (Mal Keshar) ( _ "That's one heck of a history, that I still have to digest.")}
        {MSG_UNIT Erathan ( _ "Really? Do you have a stomach in there?")}
        {MSG_UNIT Igor ( _ "Eeeeew.")}
        {MSG_UNIT Elynia ( _ "I guess this explains the strange lifeforms we have found in here. Then, someone unleashed these creatures from their container pods.")}
        {MSG_UNIT Galas ( _ "I think that whoever did that should have been smart enough to have read this story, right? That means he or she did it on purpose. Perhaps it would have been better if that person had been assimilated by these creatures too.")}
        {MSG_UNIT (Mal Keshar) ( _ "Well, perhaps they were assimilated already.")}
    [/event]

    [event]
        name=union trance effect
        first_time_only=no
        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            variable=trance_elynia_store
        [/store_unit]
        [store_unit]
            [filter]
                id=Mal Keshar
            [/filter]
            variable=trance_malin_store
        [/store_unit]

        {VARIABLE trance_elynia_store.attacks_left 0}
        {VARIABLE trance_malin_store.attacks_left  0}
        {VARIABLE trance_elynia_store.moves        0}
        {VARIABLE trance_malin_store.moves         0}

        [unstore_unit]
            variable=trance_malin_store
            find_vacant=no
        [/unstore_unit]
        [unstore_unit]
            variable=trance_elynia_store
            find_vacant=no
        [/unstore_unit]

        {CLEAR_VARIABLE trance_malin_store,trance_elynia_store}
    [/event]

    [event]
        name=union trance end
        first_time_only=yes

        {THUNDER ({QUAKE (rumble.ogg)})}
        {THUNDER ()}
        {THUNDER ()}
        {THUNDER ({QUAKE (cave-in.ogg)})}
        {THUNDER ()}

        [object]
            id=union_elynia
            duration=forever
            silent=yes
            [filter]
                id=Elynia
            [/filter]
            [effect]
                apply_to=new_ability
                [abilities]
                    {ABILITY_UNION}
                [/abilities]
            [/effect]
            {UNION_HP}
            {UNION_ATTACK}
            {UNION_ANIM_ELYNIA}
        [/object]
        [object]
            id=union_malin
            duration=forever
            silent=yes
            [filter]
                id=Mal Keshar
            [/filter]
            [effect]
                apply_to=new_ability
                [abilities]
                    {ABILITY_OBSCURE}
                    {ABILITY_UNION}
                [/abilities]
            [/effect]
            {UNION_HP}
            {UNION_ATTACK}
            {UNION_ANIM_MALIN}
            [effect]
                apply_to=resistance
                replace=true
                [resistance]
                    arcane=110
                    fire=100
                [/resistance]
            [/effect]
        [/object]

        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_store
        [/store_unit]
        [store_unit]
            [filter]
                id=Mal Keshar
            [/filter]
            variable=malin_store
        [/store_unit]

        # FIXME: nor the halo changes nor the following code that
        # modifies attack_anim's filters are working in 1.5.x!!!

        {VARIABLE elynia_store.halo "halo/illuminates-aura.png"}
        {VARIABLE malin_store.halo  "halo/obscures-aura.png"   }

        #
        # There's a huge issue with Ancient Lich's only attack
        # animation's filter which will make it often catch the union
        # attack before the one inserted by {UNION_ATTACK_ANIM}.
        #
        # Some ugly magic here should fix that. And I say ugly, because
        # it will break if Ancient Lich's declaration changes one way
        # or another in mainline...
        #

        [set_variables]
            name=malin_default_attack_animation
            mode=replace
            to_variable=malin_store.attack_anim[0]
        [/set_variables]
        {CLEAR_VARIABLE malin_store.attack_anim[0]}
        {CLEAR_VARIABLE malin_default_attack_animation.filter_attack.range}

        {VARIABLE malin_default_attack_animation.filter_attack.name $malin_store.attack[0].name}
        [set_variables]
            name=malin_store.attack_anim[$malin_store.attack_anim.length]
            mode=insert
            to_variable=malin_default_attack_animation
        [/set_variables]

        {VARIABLE malin_default_attack_animation.filter_attack.name $malin_store.attack[1].name}
        [set_variables]
            name=malin_store.attack_anim[$malin_store.attack_anim.length]
            mode=insert
            to_variable=malin_default_attack_animation
        [/set_variables]

        {CLEAR_VARIABLE malin_default_attack_animation}

        [unstore_unit]
            variable=elynia_store
            find_vacant=no
        [/unstore_unit]
        [unstore_unit]
            find_vacant=no
            variable=malin_store
        [/unstore_unit]

        {CLEAR_VARIABLE elynia_store,malin_store}

        {REDRAW}

        {MSG_UNIT Elyssa ( _ "Uh? No! It is... it is impossible! The Union has been summoned!")}

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Use the 'Union' with Elynia or Mal Keshar to vanquish the Warlord")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
        [/objectives]
    [/event]

    [event]
        name=union trance begin
        {MSG_UNIT Galas ( _ "Protect them!")}
        {VARIABLE trance_timeout 2}
        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Distract the Warlord for two turns, during which Elynia and Mal Keshar will not be able to move or attack")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES {ENEMY_RESPAWNING_WARNING} }
        [/objectives]
        [fire_event]
            name=union trance effect
        [/fire_event]
        [event]
            name=new turn
            first_time_only=no
            [if]
                {VARIABLE_NUMERICAL_GREATER_OR_EQUAL_THAN trance_timeout 0}
                [then]
                    {VARIABLE_DEC trance_timeout}
                [/then]
            [/if]
        [/event]
        [event]
            name=turn refresh
            first_time_only=no
            [if]
                {VARIABLE_NUMERICAL_GREATER_OR_EQUAL_THAN trance_timeout 0}
                [then]
                    [fire_event]
                        name=union trance effect
                    [/fire_event]
                [/then]
                [else]
                    [fire_event]
                        name=union trance end
                    [/fire_event]
                [/else]
            [/if]
        [/event]
    [/event]

    [event]
        name=die
        first_time_only="yes"
        [filter]
            id=Elyssa
        [/filter]
        [filter_second_attack]
            name=union
        [/filter_second_attack]

        {MSG_SPEAKER unit ( _ "Forgive me, Master...")}

        {MSG_UNIT Galas ( _ "Wait a moment, who are you in truth? Where does your master hide?")}

        {MSG_SPEAKER unit ( _ "I'm not telling you... anything...")}

        {MSG_UNIT Elynia ( _ "No, you actually will tell me. Who are you?")}

        {MSG_UNIT Galas ( _ "Elynia? What are you doing?")} # sithy magic

        {MSG_SPEAKER unit ( _ "I am Elyssa. I used to be a wandering mage who studied the remants of the ancient Empire's history, before stumbling upon the Chaos Empire and their ominous powers. The Shadow Master... he taught me things that you cannot imagine. He showed me the powers of the grand Uria! He... they, they converted me to their side, turning me into a demon... and then, the witch killed me. They resurrected me from the little remains of my body... thanks to the arcane craft mastered by him.")}

        {MSG_UNIT Elynia ( _ "Where does your master hide?")}

        {MSG_SPEAKER unit ( _ "The Halls of the Damned... the gates behind, and the Dark Hive... follow the dark road, and you will find him, in a chamber plenty of his creations...")}

        {MSG_UNIT Elynia ( _ "Now you can pass in peace, Elyssa.")}

        {MSG_NARRATOR ( _ "As Elyssa performed her last breathe, her former appearance returned, showing that of a beautiful red-haired human mage.")}

        {MSG_NARRATOR ( _ "But the group could not rest even for a while, nor give the poor victim a proper burial. So they threw her still warm corpse to the lava to be completely consumed, and purposefully headed towards the Halls of the Damned...")}

        {ENDLEVEL_CONTINUE}
    [/event]

    [event]
        name=die
        first_time_only="no"
        [filter]
            id=Elyssa
        [/filter]
        [filter_second_attack]
            [not]
                name=union
            [/not]
        [/filter_second_attack]
        [unit]
            side=3
            attacks_left,moves=0,0 # in case she's respawned during her own turn
            type=Chaos Warlord
            id=Elyssa
            name= _ "Elyssa"
            x,y=65,18
            {IS_BOSS}
            unrenamable=yes
            facing=$unit.facing
            female=yes
        [/unit]
    [/event]

    [event]
        name=die
        first_time_only="yes"
        [filter]
            id=Elyssa
        [/filter]
        [filter_second_attack]
            [not]
                name=union
            [/not]
        [/filter_second_attack]

        {MSG_UNIT Elyssa ( _ "I told you so, fools. I am immortal!")}

        {MSG_UNIT Galas ( _ "If none of you can think of a good idea, this is surely our end! Our backs are surrounded by lava, and it seems that no matter what we try, we won't defeat her!")}

        {MSG_UNIT Elynia ( _ "I... there is nothing that we can do against this unnatural power. If only Argan were still with us... unless... I... I have an idea...")}

        {MSG_UNIT Lédinor ( _ "What would it be?")}

        {MSG_UNIT Igor ( _ "Anything is better than nothing now!")}

        {MSG_UNIT Elynia ( _ "It is highly risky... and I'll need Malin's help. Malin, can I trust you and place our lives on your hands?")}

        {MSG_UNIT (Mal Keshar) ( _ "Eh... your lives? What are you thinking...")}

        {MSG_UNIT Elynia ( _ "We need to put our hands together and concentrate.")}

        {MSG_UNIT Elynia ( _ "When you chose this unlife for yourself, you bind yourself to the ways of Darkness for the rest of eternity. There is nothing that can be done to remedy that now. However, the powers of Darkness are not necessarily evil by themselves; they CAN be put to god use. If we work together, I am sure we can call upon the ultimate balance of Light and Darkness, and use it to turn this fight to our side.")}

        {MSG_UNIT Elynia ( _ "We will try to call upon the power of the Union using your mastery of Darkness to replace Argan's.")}

        {MSG_UNIT (Mal Keshar) ( _ "We will WHAT?! No, no, wait! I am no hero! I... am not supposed to do this... I am supposed to kill you, and be on my merry way to eternal damnation...")}

        {MSG_UNIT Elynia ( _ "Malin, you did many things in the past, many wrong things. But you also did us a great good... you guided Galas and his loyal followers to the deepest parts of Irdya, awoke me from my long sleep, and opened my blind eyes to the new order. You cannot say you are not suited for this task anymore. It is your fate, after all; would you prefer to remain hidden underground like a rat? Or would you rather fight for a just cause a last time?")}

        {MSG_UNIT (Mal Keshar) ( _ "Pah, alright. You command, Elynia...")}

        {MSG_UNIT Elynia ( _ "We must not be interrupted! You'll have to find a way to distract the Warlord for now, Galas.")}

        {MSG_UNIT Galas ( _ "So we'll do.")}

        {MSG_UNIT Erathan ( _ "Aye.")}

        {MSG_UNIT Lédinor ( _ "Aye!")}

        {MSG_UNIT Igor ( _ "Yeah!")}

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Move Elynia and Mal Keshar so that they are in adjacent hexes")}
            {OBJECTIVE_TO_WIN ( _ "Distract the Warlord")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES {ENEMY_RESPAWNING_WARNING} }
        [/objectives]

        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            kill=no
            variable=elynia_store
        [/store_unit]
        [store_unit]
            [filter]
                id=Mal Keshar
            [/filter]
            kill=no
            variable=malin_store
        [/store_unit]

        {VARIABLE       x_diff $elynia_store.x}
        {VARIABLE       y_diff $elynia_store.y}
        {VARIABLE_MINUS x_diff $malin_store.x }
        {VARIABLE_MINUS y_diff $malin_store.y }
        {ABS            x_diff                }
        {ABS            y_diff                }

        {CLEAR_VARIABLE elynia_store,malin_store}

        [if]
            {VARIABLE_NUMERICAL_EQUALS x_diff 1}
            {VARIABLE_NUMERICAL_EQUALS y_diff 1}
            [then]
                [fire_event]
                    name=union trance begin
                [/fire_event]
            [/then]
            [else]
                [event]
                    name=moveto
                    first_time_only=no
                    [filter]
                        id=Elynia
                        [filter_adjacent]
                            id=Mal Keshar
                        [/filter_adjacent]
                        [or]
                            id=Mal Keshar
                            [filter_adjacent]
                                id=Elynia
                            [/filter_adjacent]
                        [/or]
                    [/filter]
                    [fire_event]
                        name=union trance begin
                    [/fire_event]
                [/event]
            [/else]
        [/if]
    [/event]
[/scenario]
